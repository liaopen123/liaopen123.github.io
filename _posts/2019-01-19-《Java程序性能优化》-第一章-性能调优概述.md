---
layout:     post
title:《Java程序性能优化》
subtitle: 第一章-性能调优概述
date:      2019-01-19
author:     Pony
header-img: img/post-bg-mayday-bubble.jpg
catalog: true
tags:
    - Java程序性能优化
---
主要包含性能指标和整体解决优化的方案，和2大原理。
## 性能概述
### 能看懂程序的性能
一个程序的性能的表现：
1. 程序执行的速度：是否迅速，响应足够短。
2. 内存的分配：避免OOM和内存泄漏。
3. 启动的时间：项目运行，到可以处理正常逻辑的速度。
4. 负载承受能力：当系统压力上升，响应的时间曲线是否平缓。


### 性能参数指标有哪些
衡量性能参数的指标包含：
1. 执行时间：代码运行开始到结束所使用的时间。
2. CPU时间：程序占用CPU的时间。
3. 磁盘的I/O速度：磁盘读取写入消耗的时间。
4. 内存分配：占用的内存空间。
5. 网络吞吐量：网络使用情况。
6. 响应时间：系统对用户行为的响应时间。

### 木桶原理和阿姆达尔(Amdahl)原理
#### 木桶原理
衡量一个系统的**最终性能**取决于**性能最差的组件**，因此要提高系统性能，要从最差的组件开始解决问题。
系统中这些瓶颈有可能是：
1. 磁盘的I/O:读写速度慢会拖累整个系统。
2. CPU:对资源计算比较高的引用，CPU也有可能成为瓶颈。
3. 异常：对于java应用来说，异常的**捕获**和**处理**是**非常消耗资源的。**如果程序高频的处理异常，也会拖累到整个程序。
4. 锁竞争：对于高并发的系统来说，锁竞争会增加线程对上下文的切换的资源。占用宝贵的CPU资源。
5. 数据库：数据库的读写也会影响性能。
6. 内存：由于内存相当于磁盘小的可怜，尽可能的将核心数据读入内存，也会降低系统性能。
#### 阿姆达尔定律
结论：**一味的增加CPU的数量**，**并不能**彻底提高性能，还需要提升系统的代码**并行比重**。
##### 加速比
加速比的定义：
加速比= 优化前销毁的时间/优化后消耗的时间。
加速比值越大 代表优化的效果越好。
阿姆达尔定律给了加速比speedup的定义公式，其中**F表示串行比率**(例如5个步骤中3个步骤必须串行，则串行率为3/5 = 0.6),**N表示了CPU的核数。**
则：

$$ speedup = \dfrac{1}{F+\dfrac{{1-F}}{N}} $$
**当CPU核数无穷大的时候，系统的加速比与串行率成反比。**
![](https://ws2.sinaimg.cn/large/006tNc79ly1fzbqvmdko1j30uw078dg6.jpg)
通过添加1个cpu进行优化，则系统变为：
![](https://ws2.sinaimg.cn/large/006tNc79ly1fzbqz2f508j30t006e74h.jpg)
则加速比：
```
speedup = (100*5)/100*3+50*2 
1.25
```
通过阿姆达尔理论计算：

$$ speedup = \dfrac{1}{0.6+\dfrac{{1-0.6}}{2}} $$
也为1.25

当CPU无限多的时候，加速比无穷趋近于1.67。所以一味提高CPU个数并不能提高加速比，还需要提高代码的并行率。
##性能调优的层次
性能优化解决出发点可以从4个方面出发：
1. 软件架构上
2. 代码上
3. JVM
4. 数据库
5. 操作系统


### 通过架构设计调优
架构上优化需要优化人员必须熟悉:
1. 软件设计方法
2. 设计模式
3. 基本性能组件
4. 常用优化思路


### 通过代码调优
代码优化需要开发人员熟悉先关API,对算法，数据结构灵活运用。

### 通过JVM的调优
JVM调优，需要开发人员熟悉JVM运行原理和基本的内存结构。

### 数据库的调优
数据库调优包含：
1. sql语句的优化
2. 数据库表的优化
3. 数据库软件的优化


### 操作系统的调优
略

## 调优的步骤和注意事项
### 步骤
发现问题，解决问题，测试问题，继续解决，达到要求。
### 注意事项
优化必然会带来新的代码。从而来了风险，需要权衡利弊，不能因为优化而优化。